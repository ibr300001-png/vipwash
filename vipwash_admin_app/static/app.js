document.addEventListener('click',(e)=>{if(e.target.classList.contains('tab')){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(p=>p.style.display='none');e.target.classList.add('active');document.getElementById(e.target.dataset.tab).style.display='block';}});let qr,lastToken=null;const $=s=>document.querySelector(s);async function startScanner(){if(qr)return;qr=new Html5Qrcode('qr-viewfinder');try{await qr.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:250}},onScan);}catch(err){console.error(err);}}async function stopScanner(){if(!qr)return;try{await qr.stop();}catch(_){}qr.clear();qr=null;}async function onScan(text){lastToken=text;$('#tokenRO').value=text;const r=await fetch('/api/scan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:text})});const j=await r.json();if(j.ok){$('#clientInfo').innerText=`الاسم: ${j.client.name} | الجوال: ${j.client.phone} | اللوحة: ${j.client.plate} | الزيارات: ${j.client.visits}`;$('#mApprove').disabled=false;$('#mRedeem').disabled=false;openModal('#clientModal');}}$('#btnStart')?.addEventListener('click',startScanner);$('#btnStop')?.addEventListener('click',stopScanner);$('#mApprove')?.addEventListener('click',async()=>{const parts=($('#clientInfo').innerText||'').split('|');const phone=(parts[1]||'').replace(' الجوال: ','').trim();const plate=(parts[2]||'').replace(' اللوحة: ','').trim();const r=await fetch('/api/approve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,plate,rating:5})});const j=await r.json();if(j.ok){closeModal('#clientModal');alert('تم اعتماد الزيارة');}});async function loadUsers(){const box=document.getElementById('u_list');if(!box)return;const r=await fetch('/api/users');const j=await r.json();if(!j.ok){box.innerHTML='<div class="muted">!</div>';return;}let html=`<div class="thead"><div>اسم</div><div>دور</div></div>`;(j.users||[]).forEach(u=>{html+=`<div class="trow"><div>${u.username}</div><div>${u.role} <button class="btn btn-gray" onclick="editU(${u.id},'${u.username}','${u.role}')">تعديل</button> <button class="btn btn-dark" onclick="delU(${u.id})">حذف</button></div></div>`;});box.innerHTML=html;}window.editU=(id,name,role)=>{$('#u_id').value=id;$('#u_name').value=name;$('#u_pass').value='';$('#u_role').value=role;};window.delU=async(id)=>{if(!confirm('حذف المستخدم؟'))return;await fetch('/api/users',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});loadUsers();};document.getElementById('u_save')?.addEventListener('click',async()=>{const payload={id:$('#u_id').value||null,username:$('#u_name').value.trim(),password:$('#u_pass').value||null,role:$('#u_role').value};await fetch('/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});$('#u_id').value='';$('#u_name').value='';$('#u_pass').value='';loadUsers();});document.getElementById('s_save')?.addEventListener('click',async()=>{await fetch('/api/save_settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({points_per_visit:+$('#s_ppv').value,redeem_limit:+$('#s_lim').value,front_text:$('#s_ftxt')?.value||'',front_link:$('#s_flnk')?.value||'',draw_text:$('#s_draw')?.value||''})});alert('تم الحفظ');});document.getElementById('t_save')?.addEventListener('click',()=>{document.getElementById('s_save')?.click();});